<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mandya Smart Transport</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet (FREE MAP) -->
<link rel="stylesheet"
 href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{margin:0;font-family:Segoe UI;background:#0b1d2a;color:#fff}
header{padding:16px;text-align:center;background:#0008;position:relative}
.lang{position:absolute;right:10px;top:10px}
button{padding:6px 12px;border:none;border-radius:10px;cursor:pointer}
#map{height:65vh;width:100%;margin:10px;border-radius:14px}
.container{padding:10px}
input{width:100%;padding:12px;border-radius:20px;border:none;margin:10px 0}
.card{background:#ffffff1a;padding:14px;border-radius:16px;margin-bottom:10px}
.live{color:#00ff9c;font-weight:bold}
</style>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>

<header>
  <h2 id="title">Mandya Smart Transport System</h2>
  <p id="subtitle">Live Bus Tracking • All Villages</p>
  <div class="lang">
    <button onclick="setLang('en')">EN</button>
    <button onclick="setLang('kn')">KN</button>
  </div>
</header>

<div id="map"></div>

<div class="container">
  <input id="search" placeholder="Search village / stop">
  <div id="list"></div>
</div>

<script>
/* ================= LANGUAGE ================= */
const text={
 en:{
  title:"Mandya Smart Transport System",
  sub:"Live Bus Tracking • All Villages",
  search:"Search village / stop",
  from:"From Mandya Bus Stand",
  eta:"ETA"
 },
 kn:{
  title:"ಮಂಡ್ಯ ಸ್ಮಾರ್ಟ್ ಸಾರಿಗೆ ವ್ಯವಸ್ಥೆ",
  sub:"ಲೈವ್ ಬಸ್ ಟ್ರ್ಯಾಕಿಂಗ್ • ಎಲ್ಲಾ ಗ್ರಾಮಗಳು",
  search:"ಗ್ರಾಮ / ನಿಲ್ದಾಣ ಹುಡುಕಿ",
  from:"ಮಂಡ್ಯ ಬಸ್ ನಿಲ್ದಾಣದಿಂದ",
  eta:"ಬರುವ ಸಮಯ"
 }
};
let lang="en";

function setLang(l){
 lang=l;
 title.innerText=text[l].title;
 subtitle.innerText=text[l].sub;
 search.placeholder=text[l].search;
 render(filteredVillages());
}

/* ================= MAP (FREE) ================= */
 const map = L.map('map').setView([12.54, 76.90], 14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
 attribution:'© OpenStreetMap'
}).addTo(map);

/* ================= FIREBASE ================= */
firebase.initializeApp({
 apiKey: "AIzaSyBnyefKIay-e8astJAyaUPOE38USw2lEes",
 authDomain:  "mandyasmarttransport-396fe.firebaseapp.com",
 projectId: "mandyasmarttransport-396fe",
});
const db = firebase.firestore();

/* ================= VILLAGES ================= */
const villages=[
 {name:"Mandya",kn:"ಮಂಡ್ಯ",km:0},
 {name:"Basaralu",kn:"ಬಸರಾಳು",km:6},
 {name:"Keragodu",kn:"ಕೆರಗೋಡು",km:8},
 {name:"Kyathanahalli",kn:"ಕ್ಯಾತನಹಳ್ಳಿ",km:10},
 {name:"Guthalu",kn:"ಗುತ್ಥಲು",km:12},
 {name:"Chinakurali",kn:"ಚಿನಕುರಳಿ",km:16},
 {name:"Pandavapura",kn:"ಪಾಂಡವಪುರ",km:25},
 {name:"Malavalli",kn:"ಮಳವಳ್ಳಿ",km:35}
];

/* ================= ETA ================= */
function eta(km){
 return Math.max(3,Math.round((km/30)*60));
}

/* ================= UI ================= */
const listDiv=document.getElementById("list");

function filteredVillages(){
 const v=search.value?.toLowerCase()||"";
 return villages.filter(x =>
  x.name.toLowerCase().includes(v) ||
  x.kn.includes(v)
 );
}

function render(list){
 listDiv.innerHTML="";
 list.forEach(v=>{
  listDiv.innerHTML+=`
   <div class="card">
    <b>${lang==="en"?v.name:v.kn}</b>
    <p>${text[lang].from}</p>
    <p>${text[lang].eta}: ${eta(v.km)} min</p>
    <p class="live">● LIVE TRACKING</p>
   </div>`;
 });
}
render(villages);
search.onkeyup=()=>render(filteredVillages());

/* ================= LIVE BUS TRACKING ================= */
const markers={};

db.collection("buses").onSnapshot(snapshot=>{
 snapshot.forEach(doc=>{
  const b=doc.data();
  const pos=[b.lat,b.lng];
  if(markers[doc.id]){
   markers[doc.id].setLatLng(pos);
  }else{
   markers[doc.id]=L.marker(pos)
     .addTo(map)
     .bindPopup("Bus: "+b.busNo);
  }
  map.setView(pos, 15);

 });
});
<script>
  // Initialize map centered on Mandya
  var map = L.map('map').setView([12.5242, 76.8958], 12);

  // Free OpenStreetMap tiles (NO payment needed)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // Bus icon
  var busIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/61/61231.png',
    iconSize: [35, 35]
  });

  // Bus marker (Mandya Bus Stand)
  var busMarker = L.marker([12.5242, 76.8958], {
    icon: busIcon
  }).addTo(map).bindPopup("Bus KA-11-A-1234");

  // Simulated live movement
  var route = [
    [12.5242, 76.8958],
    [12.5342, 76.9058],
    [12.5442, 76.9158],
    [12.5542, 76.9258]
  ];

  var i = 0;
  setInterval(() => {
    i = (i + 1) % route.length;
    busMarker.setLatLng(route[i]);
  }, 3000);
</script>


</body>
</html>
